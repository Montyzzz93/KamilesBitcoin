<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kamile's BTC Portfolio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --btc-orange:#f7931a; --gbp-blue:#1a7bf7; --profit-green:#21a453; --loss-red:#cf304a;
      --bg-color:#f8f9fc; --card-bg:#ffffff; --text-main:#1e2329; --text-sub:#707a8a; --border:#eaecf0;
    }
    body{
      font-family:'Inter',sans-serif; background:var(--bg-color); color:var(--text-main);
      margin:0; padding:15px; display:flex; justify-content:center;
    }
    .container{
      width:100%; max-width:440px; background:var(--card-bg); padding:24px;
      border-radius:24px; box-shadow:0 4px 20px rgba(0,0,0,0.03);
    }
    h2{ font-size:1.1rem; font-weight:700; margin:0 0 15px 0; text-align:center; }
    .header-section{ text-align:center; margin-bottom:20px; }
    .qr-container{
      background:#fff; padding:10px; border-radius:16px; display:inline-block;
      border:1px solid var(--border); margin-bottom:12px;
    }
    .qr-container img{ width:120px; height:120px; display:block; }
    .address-pill{
      background:#f0f2f5; padding:8px 12px; border-radius:50px; cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .address-text{
      font-family:monospace; font-size:10px; color:var(--text-sub);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:300px;
    }
    .dashboard-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:25px; }
    .stat-box{
      padding:12px; border-radius:16px; color:white; display:flex;
      flex-direction:column; align-items:center;
    }
    .btc-box{ background:var(--btc-orange); }
    .gbp-box{ background:var(--gbp-blue); }
    .invested-box{ background:#474d57; }
    .avg-box{ background:#6c5ce7; }
    .profit-box{ background:#f1f3f5; color:var(--text-main); grid-column:span 2; text-align:center; }
    .label{ font-size:9px; font-weight:600; text-transform:uppercase; opacity:0.8; margin-bottom:4px; }
    .val{ font-size:0.95rem; font-weight:700; }

    .section-title{
      font-weight:700; margin-bottom:12px; font-size:0.95rem;
      border-bottom:1px solid var(--border); padding-bottom:8px;
    }
    .tx-item{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 0; border-bottom:1px solid var(--border);
    }
    .tx-date{ font-size:11px; font-weight:600; display:block; }
    .tx-basis{ font-size:10px; color:var(--text-sub); display:block; }
    .tx-values{ text-align:right; }
    .tx-btc{ font-size:12px; font-weight:700; display:block; }
    .tx-gbp-then{ font-size:10px; color:var(--text-sub); display:block; margin-top:2px; }
    .received{ color:var(--profit-green); }
    .sent{ color:var(--loss-red); }

    #loading-msg{ text-align:center; font-size:12px; color:var(--text-sub); margin-top:10px; }
    .cache-footer{
      font-size:10px; color:var(--text-sub); text-align:center; margin-top:20px;
      cursor:pointer; text-decoration:underline;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header-section">
    <h2>Kamile's Wallet</h2>
    <div class="qr-container">
      <img src="https://raw.githubusercontent.com/Montyzzz93/KamilesBitcoin/refs/heads/main/kamilesQR.png" alt="QR">
    </div>

    <div class="address-pill" onclick="copyAddress()">
      <span class="address-text">bc1q2uq0gae44n9ga4navc9zjlg7h937j2mrf2pkgh</span>
      <span style="font-size:9px;font-weight:700;color:var(--btc-orange);" id="copy-hint">COPY</span>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="stat-box btc-box"><span class="label">Holdings</span><span class="val" id="curr-btc">... BTC</span></div>
    <div class="stat-box gbp-box"><span class="label">Market Value</span><span class="val" id="curr-gbp">...</span></div>
    <div class="stat-box invested-box"><span class="label">Total Invested</span><span class="val" id="total-invested">...</span></div>
    <div class="stat-box avg-box"><span class="label">Avg Buy Price</span><span class="val" id="avg-buy">...</span></div>
    <div class="stat-box profit-box"><span class="label">Total Profit / Loss</span><span class="val" id="total-profit">Calculating...</span></div>
  </div>

  <div class="section-title">All Activity</div>
  <div id="tx-content">
    <div id="loading-msg">Connecting to blockchain...</div>
  </div>

  <div class="cache-footer" onclick="clearPriceCache()">Clear Price Cache</div>
</div>

<script>
  const wallet = "bc1q2uq0gae44n9ga4navc9zjlg7h937j2mrf2pkgh";
  const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  function fmtGBP(v) {
    return v.toLocaleString('en-GB', { style: 'currency', currency: 'GBP' });
  }

  async function mustJson(res) {
    if (!res.ok) throw new Error(`HTTP ${res.status} from ${res.url}`);
    return res.json();
  }

  function safeLSGet(key) {
    try { return localStorage.getItem(key); } catch { return null; }
  }
  function safeLSSet(key, value) {
    try { localStorage.setItem(key, value); } catch {}
  }
  function safeLSRemove(key) {
    try { localStorage.removeItem(key); } catch {}
  }

  async function copyAddress() {
    let copied = false;

    // Modern API
    try {
      await navigator.clipboard.writeText(wallet);
      copied = true;
    } catch {}

    // Fallback
    if (!copied) {
      try {
        const ta = document.createElement("textarea");
        ta.value = wallet;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.top = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        copied = document.execCommand("copy");
        ta.remove();
      } catch {}
    }

    if (!copied) {
      alert("Copy failed on this browser. Please copy manually:\n\n" + wallet);
    }

    const hint = document.getElementById('copy-hint');
    hint.innerText = "DONE!";
    setTimeout(() => hint.innerText = "COPY", 1500);
  }

  function clearPriceCache() {
    safeLSRemove('kamile_btc_prices');
    alert("Price cache cleared. It will refresh on next load.");
    location.reload();
  }

  // Fetch ALL confirmed chain txs via pagination
  async function fetchAllChainTxs(addr, statusEl) {
    const all = [];
    let lastTxid = null;

    for (;;) {
      const url = lastTxid
        ? `https://mempool.space/api/address/${addr}/txs/chain/${lastTxid}`
        : `https://mempool.space/api/address/${addr}/txs/chain`;

      if (statusEl) statusEl.innerText = lastTxid ? `Loading more transactions... (${all.length})` : "Loading transactions...";

      const page = await mustJson(await fetch(url));
      if (!Array.isArray(page) || page.length === 0) break;

      all.push(...page);
      lastTxid = page[page.length - 1].txid;

      // Safety stop
      if (all.length > 5000) break;

      await sleep(150);
    }

    return all;
  }

  function setProfitUI(currentTotalValue, totalInvestedGBP) {
    const profitEl = document.getElementById('total-profit');
    const profit = currentTotalValue - totalInvestedGBP;

    let profitPct = "0.0";
    if (totalInvestedGBP > 0) {
      profitPct = ((profit / totalInvestedGBP) * 100).toFixed(1);
    }

    profitEl.innerText = `${profit > 0 ? '+' : ''}${fmtGBP(profit)} (${profitPct}%)`;
    profitEl.style.color = profit > 0 ? 'var(--profit-green)' : 'var(--loss-red)';
  }

  async function fetchHistoricalGBP(dateStr, curPrice, statusEl2, i, total) {
    if (statusEl2) {
      const pct = Math.round((i / Math.max(1, total)) * 100);
      statusEl2.innerText = `Fetching price history... ${pct}% (${i}/${total})`;
    }

    const histRes = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/history?date=${dateStr}&localization=false`);

    // If rate-limited or failing: fall back to current price
    if (!histRes.ok) {
      if (histRes.status === 429 && statusEl2) {
        statusEl2.innerText = "CoinGecko rate limit (429). Using current price for some days...";
      }
      return curPrice;
    }

    let histData = null;
    try {
      histData = await histRes.json();
    } catch {
      return curPrice;
    }

    return histData?.market_data?.current_price?.gbp || curPrice;
  }

  async function fetchData() {
    const container = document.getElementById('tx-content');
    container.innerHTML = `<div id="loading-msg">Connecting to blockchain...</div>`;
    const statusEl = document.getElementById('loading-msg');

    try {
      // Step 1: fast data (price + balance)
      const [priceRes, balanceRes] = await Promise.all([
        fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=gbp"),
        fetch(`https://mempool.space/api/address/${wallet}`)
      ]);

      const prices = await mustJson(priceRes);
      const balance = await mustJson(balanceRes);

      const curPrice = prices?.bitcoin?.gbp;
      if (!curPrice) throw new Error("CoinGecko price missing");

      const btcAmount = (balance.chain_stats.funded_txo_sum - balance.chain_stats.spent_txo_sum) / 100000000;
      const currentTotalValue = btcAmount * curPrice;

      document.getElementById('curr-btc').innerText = `${btcAmount.toFixed(6)} BTC`;
      document.getElementById('curr-gbp').innerText = fmtGBP(currentTotalValue);

      // Step 2: fetch all txs (paged)
      const txs = await fetchAllChainTxs(wallet, statusEl);

      // Mempool returns newest-first; if that ever changes, enforce sort:
      txs.sort((a,b) => (b?.status?.block_time || 0) - (a?.status?.block_time || 0));

      // Step 3: load cache safely
      let priceCache = {};
      try {
        priceCache = JSON.parse(safeLSGet('kamile_btc_prices') || "{}") || {};
      } catch {
        priceCache = {};
      }

      let totalInvestedGBP = 0;
      let totalBTCReceived = 0;

      // Prepare UI list + status line
      container.innerHTML = `<div id="loading-msg"></div>`;
      const statusEl2 = document.getElementById('loading-msg');

      // Live UI init
      document.getElementById('total-invested').innerText = fmtGBP(0);
      document.getElementById('avg-buy').innerText = fmtGBP(0);
      setProfitUI(currentTotalValue, 0);

      for (let i = 0; i < txs.length; i++) {
        const tx = txs[i];

        // Confirmed tx time or null
        const ts = tx?.status?.block_time;
        const dateObj = ts ? new Date(ts * 1000) : null;

        // If unconfirmed: show, but don't try history endpoint (no stable date)
        let historicalPrice = curPrice;
        let dateStr = null;

        if (dateObj) {
          const day = String(dateObj.getDate()).padStart(2, '0');
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const year = dateObj.getFullYear();
          dateStr = `${day}-${month}-${year}`;

          if (priceCache[dateStr]) {
            historicalPrice = priceCache[dateStr];
          } else {
            historicalPrice = await fetchHistoricalGBP(dateStr, curPrice, statusEl2, i + 1, txs.length);
            priceCache[dateStr] = historicalPrice;
            safeLSSet('kamile_btc_prices', JSON.stringify(priceCache));

            // Only sleep when we actually hit CoinGecko history API
            if (i < txs.length - 1) await sleep(2100);
          }
        }

        let rcv = 0, snt = 0;
        tx.vout?.forEach(o => { if (o.scriptpubkey_address === wallet) rcv += o.value; });
        tx.vin?.forEach(v => { if (v.prevout?.scriptpubkey_address === wallet) snt += v.prevout.value; });

        const net = (rcv - snt) / 100000000;
        if (net === 0) continue; // ignore self transfers

        const isRcv = net > 0;
        const btcVal = Math.abs(net);
        const gbpThen = btcVal * historicalPrice;

        if (isRcv) {
          totalInvestedGBP += gbpThen;
          totalBTCReceived += btcVal;
        }

        // Live dashboard update (every 2 txs, and at end)
        if (i % 2 === 0 || i === txs.length - 1) {
          document.getElementById('total-invested').innerText = fmtGBP(totalInvestedGBP);

          const avgBuyTmp = totalBTCReceived > 0 ? (totalInvestedGBP / totalBTCReceived) : 0;
          document.getElementById('avg-buy').innerText = avgBuyTmp.toLocaleString('en-GB', {
            style: 'currency', currency: 'GBP', maximumFractionDigits: 0
          });

          // Show "Syncing..." while still looping
          const profitEl = document.getElementById('total-profit');
          const tempProfit = currentTotalValue - totalInvestedGBP;
          profitEl.innerText = `Syncing... ${tempProfit > 0 ? '+' : ''}${fmtGBP(tempProfit)}`;
          profitEl.style.color = tempProfit > 0 ? 'var(--profit-green)' : 'var(--loss-red)';
        }

        const dateLabel = dateObj
          ? dateObj.toLocaleDateString([], { month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit' })
          : "Unconfirmed";

        const rateLabel = dateObj
          ? `Rate: £${Math.round(historicalPrice).toLocaleString()}`
          : `Rate: £${Math.round(curPrice).toLocaleString()} (current)`;

        const item = document.createElement('div');
        item.className = 'tx-item';
        item.innerHTML = `
          <div>
            <span class="tx-date">${dateLabel}</span>
            <span class="tx-basis">${rateLabel}</span>
          </div>
          <div class="tx-values">
            <span class="tx-btc ${isRcv ? 'received' : 'sent'}">${isRcv ? '+' : '-'}${btcVal.toFixed(6)}</span>
            <span class="tx-gbp-then">Worth then £${gbpThen.toFixed(2)}</span>
          </div>
        `;
        container.appendChild(item);
      }

      if (statusEl2) statusEl2.innerText = "";

      const avgBuy = totalBTCReceived > 0 ? (totalInvestedGBP / totalBTCReceived) : 0;

      document.getElementById('total-invested').innerText = fmtGBP(totalInvestedGBP);
      document.getElementById('avg-buy').innerText = avgBuy.toLocaleString('en-GB', {
        style: 'currency', currency: 'GBP', maximumFractionDigits: 0
      });

      setProfitUI(currentTotalValue, totalInvestedGBP);

    } catch (e) {
      console.error(e);
      container.innerHTML = "CoinGecko / Mempool is busy. Wait 60 seconds and refresh.";
    }
  }

  fetchData();
</script>

</body>
</html>
